name: SonarQube Analysis

# DÃ©clencheurs automatiques
on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
    types: [opened, synchronize, reopened]

# Variables d'environnement globales
env:
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sonarqube-analysis:
    name: SonarQube Code Analysis
    runs-on: ubuntu-latest
    
    # Timeout pour Ã©viter les jobs qui traÃ®nent
    timeout-minutes: 30
    
    steps:
      # 1. VÃ©rification et extraction du code source
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          # RÃ©cupÃ¨re tout l'historique pour une analyse complÃ¨te
          fetch-depth: 0
          # Token pour accÃ©der aux dÃ©pÃ´ts privÃ©s si nÃ©cessaire
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Configuration de l'environnement Node.js
      - name: ðŸŸ¢ Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # Pas de cache automatique car package-lock.json n'existe pas
          # Le cache sera gÃ©rÃ© manuellement par Ã©tape

      # 3. Configuration de l'environnement Java (requis pour SonarScanner)
      - name: â˜• Setup Java JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 4. Cache des dÃ©pendances npm (Backend)
      - name: ðŸ’¾ Cache Backend Dependencies
        uses: actions/cache@v4
        with:
          path: back/node_modules
          key: ${{ runner.os }}-backend-npm-${{ hashFiles('back/package.json') }}
          restore-keys: |
            ${{ runner.os }}-backend-npm-

      # 5. Installation des dÃ©pendances Backend
      - name: ðŸ“¦ Install Backend Dependencies
        working-directory: ./back
        run: |
          echo "ðŸ”§ Installing backend dependencies..."
          if [ ! -d "node_modules" ]; then
            npm install --prefer-offline --no-audit
          else
            echo "ðŸ“¦ Dependencies already cached, skipping installation"
          fi
          echo "âœ… Backend dependencies ready"

      # 6. Cache des dÃ©pendances npm (Frontend)
      - name: ðŸ’¾ Cache Frontend Dependencies
        uses: actions/cache@v4
        with:
          path: front/node_modules
          key: ${{ runner.os }}-frontend-npm-${{ hashFiles('front/package.json') }}
          restore-keys: |
            ${{ runner.os }}-frontend-npm-

      # 7. Installation des dÃ©pendances Frontend
      - name: ðŸ“¦ Install Frontend Dependencies
        working-directory: ./front
        run: |
          echo "ðŸ”§ Installing frontend dependencies..."
          if [ ! -d "node_modules" ]; then
            npm install --prefer-offline --no-audit
          else
            echo "ðŸ“¦ Dependencies already cached, skipping installation"
          fi
          echo "âœ… Frontend dependencies ready"

      # 8. Build du projet Frontend (optionnel mais recommandÃ©)
      - name: ðŸ—ï¸ Build Frontend Project
        working-directory: ./front
        run: |
          echo "ðŸ”¨ Building frontend project..."
          npm run build
          echo "âœ… Frontend build completed successfully"
        continue-on-error: true

      # 9. Installation et configuration de SonarScanner
      - name: ðŸ” Setup SonarScanner CLI
        run: |
          echo "ðŸ“¥ Downloading and installing SonarScanner..."
          wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip -q sonar-scanner-cli-5.0.1.3006-linux.zip
          sudo mv sonar-scanner-5.0.1.3006-linux /opt/sonar-scanner
          sudo ln -sf /opt/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner
          echo "âœ… SonarScanner installed successfully"
          sonar-scanner --version

      # 10. Validation des secrets requis
      - name: ðŸ” Validate Required Secrets
        run: |
          echo "ðŸ” Validating required environment variables..."
          if [ -z "$SONAR_TOKEN" ]; then
            echo "âŒ ERROR: SONAR_TOKEN secret is not set"
            exit 1
          fi
          if [ -z "$SONAR_HOST_URL" ]; then
            echo "âŒ ERROR: SONAR_HOST_URL secret is not set"
            exit 1
          fi
          echo "âœ… All required secrets are properly configured"

      # 11. PrÃ©paration des paramÃ¨tres SonarQube
      - name: ðŸ“‹ Prepare SonarQube Parameters
        run: |
          echo "ðŸ“ Preparing SonarQube analysis parameters..."
          
          # CrÃ©ation du fichier de configuration dynamique
          cat > sonar-project-ci.properties << EOF
          # Configuration SonarQube pour CI/CD
          sonar.projectKey=piweb
          sonar.projectName=Rescuify - Smart Medical Emergency Application
          sonar.projectVersion=1.0.0
          
          # Configuration du serveur SonarQube
          sonar.host.url=$SONAR_HOST_URL
          sonar.token=$SONAR_TOKEN
          
          # Sources et tests
          sonar.sources=back,front
          sonar.sourceEncoding=UTF-8
          
          # Exclusions optimisÃ©es pour les dÃ©pÃ´ts publics
          sonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/coverage/**,**/*.md,**/uploads/**,**/*.log,**/.env*,**/docker-compose.yml,**/Dockerfile
          
          # Configuration spÃ©cifique JavaScript/TypeScript
          sonar.javascript.lcov.reportPaths=coverage/lcov.info
          sonar.typescript.lcov.reportPaths=coverage/lcov.info
          
          # ParamÃ¨tres de qualitÃ©
          sonar.qualitygate.wait=true
          sonar.qualitygate.timeout=300
          
          # MÃ©tadonnÃ©es Git pour l'analyse
          sonar.scm.provider=git
          sonar.scm.forceReloadAll=true
          
          # Configuration pour les dÃ©pÃ´ts publics GitHub
          sonar.pullrequest.provider=github
          sonar.pullrequest.github.repository=${{ github.repository }}
          EOF
          
          echo "âœ… SonarQube configuration prepared"

      # 12. ExÃ©cution de l'analyse SonarQube
      - name: ðŸ” Run SonarQube Analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          echo "ðŸš€ Starting SonarQube analysis..."
          
          # Configuration des paramÃ¨tres pour Pull Request
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "ðŸ“‹ Configuring for Pull Request analysis..."
            EXTRA_ARGS="-Dsonar.pullrequest.key=${{ github.event.pull_request.number }} \
                       -Dsonar.pullrequest.branch=${{ github.event.pull_request.head.ref }} \
                       -Dsonar.pullrequest.base=${{ github.event.pull_request.base.ref }}"
          else
            echo "ðŸ“‹ Configuring for Branch analysis..."
            EXTRA_ARGS="-Dsonar.branch.name=${{ github.ref_name }}"
          fi
          
          # ExÃ©cution de l'analyse avec gestion d'erreurs
          set -e
          sonar-scanner \
            -Dproject.settings=sonar-project-ci.properties \
            -Dsonar.projectBaseDir=. \
            -Dsonar.working.directory=.sonarqube \
            $EXTRA_ARGS \
            -Dsonar.verbose=true
          
          echo "âœ… SonarQube analysis completed successfully"

      # 13. VÃ©rification du Quality Gate
      - name: ðŸŽ¯ Check Quality Gate Status
        run: |
          echo "ðŸ” Checking Quality Gate status..."
          
          # Attendre que le Quality Gate soit Ã©valuÃ©
          sleep 10
          
          # Note: Le statut du Quality Gate est automatiquement vÃ©rifiÃ© par sonar.qualitygate.wait=true
          echo "âœ… Quality Gate verification completed"

      # 14. Nettoyage des fichiers temporaires
      - name: ðŸ§¹ Cleanup Temporary Files
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up temporary files..."
          rm -rf .sonarqube/ || true
          rm -f sonar-project-ci.properties || true
          echo "âœ… Cleanup completed"

  # Job de notification en cas d'Ã©chec
  notify-failure:
    name: ðŸ“¢ Notify on Failure
    runs-on: ubuntu-latest
    needs: sonarqube-analysis
    if: failure()
    
    steps:
      - name: ðŸ“§ Send Failure Notification
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const { number } = context.issue;
            
            // CrÃ©er un commentaire sur la PR ou un issue
            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.payload.pull_request.number,
                body: `## âŒ SonarQube Analysis Failed
                
                The SonarQube analysis has failed for this pull request.
                
                **Details:**
                - Workflow: \`${{ github.workflow }}\`
                - Run ID: \`${{ github.run_id }}\`
                - Commit: \`${{ github.sha }}\`
                
                Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.
                
                ðŸ”§ **Common issues to check:**
                - SonarQube server connectivity
                - Authentication tokens
                - Code quality issues
                - Build failures`
              });
            }
            
            console.log('Failure notification sent successfully');

  # Job de notification en cas de succÃ¨s
  notify-success:
    name: âœ… Notify on Success
    runs-on: ubuntu-latest
    needs: sonarqube-analysis
    if: success()
    
    steps:
      - name: ðŸŽ‰ Send Success Notification
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('âœ… SonarQube analysis completed successfully!');
            
            // Optionnel: Ajouter un commentaire de succÃ¨s sur les PR
            if (context.eventName === 'pull_request') {
              const { owner, repo } = context.repo;
              
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.payload.pull_request.number,
                body: `## âœ… SonarQube Analysis Passed
                
                The SonarQube analysis has completed successfully! ðŸŽ‰
                
                **Analysis Details:**
                - Project: \`piweb\`
                - Workflow: \`${{ github.workflow }}\`
                - Commit: \`${{ github.sha }}\`
                
                You can view the detailed results in your SonarQube dashboard.`
              });
            }